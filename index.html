<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Spin the Wheel - Loyalty Points</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    h1 { color: #4CAF50; }
    canvas { margin-top: 20px; display: block; margin-left: auto; margin-right: auto; }
    input, button { padding: 10px; font-size: 16px; margin: 10px; }
    #wheelResult { font-weight: bold; font-size: 24px; margin-top: 20px; }
    table { margin: 20px auto; border-collapse: collapse; width: 100%; max-width: 500px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f2f2f2; }
    #closeSession { background-color: #2196F3; color: white; }
    #resetList { background-color: #9E9E9E; color: white; }
    .arrow {
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 30px solid red;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 130px;
      z-index: 10;
    }
  </style>
</head>
<body>
  <h1>üéØ Spin the Wheel - Loyalty Points</h1>
  <input type="text" id="affiliateId" placeholder="Enter Affiliate ID" style="text-align:center; width: 250px;" />
  <div class="arrow"></div>
  <canvas id="wheelCanvas" width="400" height="400"></canvas>
  <button onclick="spinWheel()">Spin the Wheel</button>
  <p id="wheelResult"></p>
  <h2>üèÜ Current Spin</h2>
  <table id="winnerTable">
    <thead>
      <tr><th>Affiliate ID</th><th>Prize</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button id="resetList" onclick="resetDisplay()">üßπ Reset Display</button>
  <button id="closeSession" onclick="closeSession()">‚ùå Close Session & Download CSV</button>

  <script>
    const prizes = [
      { label: "5 Loyalty Points", weight: 75 },
      { label: "10 Loyalty Points", weight: 10 },
      { label: "20 Loyalty Points", weight: 10 },
      { label: "100 Loyalty Points", weight: 5 }
    ];

    const weightedPrizes = prizes.flatMap(p => Array(p.weight).fill(p.label));
    const sessionWinners = [];
    const winnerTableBody = document.querySelector("#winnerTable tbody");
    const canvas = document.getElementById("wheelCanvas");
    const ctx = canvas.getContext("2d");
    const radius = canvas.width / 2;
    const colors = ["#FFCE54", "#AC92EC", "#4FC1E9", "#ED5565"];

    let angleOffset = 0;

    function drawWheel() {
      const num = prizes.length;
      const arc = 2 * Math.PI / num;
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      prizes.forEach((prize, i) => {
        const angle = arc * i + angleOffset;
        ctx.beginPath();
        ctx.moveTo(radius, radius);
        ctx.arc(radius, radius, radius, angle, angle + arc);
        ctx.fillStyle = colors[i % colors.length];
        ctx.fill();
        ctx.save();
        ctx.translate(radius, radius);
        ctx.rotate(angle + arc / 2);
        ctx.fillStyle = "#000";
        ctx.textAlign = "right";
        ctx.font = "14px Arial";
        ctx.fillText(prize.label, radius - 10, 5);
        ctx.restore();
      });
    }

    function spinWheel() {
      const affiliateId = document.getElementById("affiliateId").value.trim();
      if (!affiliateId) {
        alert("Please enter an Affiliate ID.");
        return;
      }

      const spins = 5;
      const selectedPrize = weightedPrizes[Math.floor(Math.random() * weightedPrizes.length)];
      const prizeIndex = prizes.findIndex(p => p.label === selectedPrize);
      const arc = 2 * Math.PI / prizes.length;
      const targetAngle = (Math.PI * 2 * spins) + ((prizes.length - prizeIndex - 0.5) * arc);
      let start = null;

      function animate(timestamp) {
        if (!start) start = timestamp;
        const progress = timestamp - start;
        const duration = 3000;
        const ease = 1 - Math.pow(1 - progress / duration, 3);
        angleOffset = targetAngle * ease;
        drawWheel();

        if (progress < duration) {
          requestAnimationFrame(animate);
        } else {
          document.getElementById("wheelResult").innerText = `üéâ ${affiliateId} won ${selectedPrize}!`;
          winnerTableBody.innerHTML = "";
          const row = winnerTableBody.insertRow();
          row.insertCell(0).innerText = affiliateId;
          row.insertCell(1).innerText = selectedPrize;
          sessionWinners.push({ id: affiliateId, prize: selectedPrize });
        }
      }
      requestAnimationFrame(animate);
    }

    function resetDisplay() {
      document.getElementById("wheelResult").innerText = "";
      winnerTableBody.innerHTML = "";
    }

    function closeSession() {
      if (sessionWinners.length === 0) {
        alert("No spins have occurred yet.");
        return;
      }
      let csvContent = "Affiliate ID,Prize
";
      for (let entry of sessionWinners) {
        csvContent += `${entry.id},${entry.prize}
`;
      }
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'winning_list.csv';
      a.click();

      sessionWinners.length = 0;
      document.getElementById("affiliateId").value = "";
      document.getElementById("wheelResult").innerText = "";
      winnerTableBody.innerHTML = "";
    }

    drawWheel();
  </script>
</body>
</html>
